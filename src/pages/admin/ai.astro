---
// AI Generation Mode - AIç”Ÿæˆãƒ¢ãƒ¼ãƒ‰
---
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ | BLITZ Admin</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/admin-styles.css" />
  <style>
    .ai-input-section {
      background: rgba(18,18,26,0.8); backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 1rem;
      padding: 2rem; margin-bottom: 1.5rem;
    }
    .keyword-row {
      display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-end;
    }
    .keyword-field { flex: 1; }
    .keyword-field label {
      display: block; font-size: 0.7rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: rgba(255,255,255,0.45); margin-bottom: 0.3rem;
    }
    .keyword-field input, .keyword-field select {
      width: 100%; padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem; color: #fff; font-size: 1rem;
      font-family: 'Inter', sans-serif; outline: none;
    }
    .keyword-field input:focus { border-color: #00D4FF; }
    .keyword-field select option { background: #1a1a25; }

    .generate-btn {
      padding: 0.75rem 2.5rem; height: fit-content;
      background: linear-gradient(135deg, #8B5CF6, #6D28D9);
      border: none; border-radius: 0.75rem; color: #fff;
      font-size: 1rem; font-weight: 700; font-family: 'Inter', sans-serif;
      cursor: pointer; transition: all 0.3s; white-space: nowrap;
    }
    .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139,92,246,0.4); }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Progress */
    .ai-progress {
      display: none; background: rgba(18,18,26,0.8); backdrop-filter: blur(15px);
      border: 1px solid rgba(139,92,246,0.2); border-radius: 1rem;
      padding: 2rem; margin-bottom: 1.5rem; text-align: center;
    }
    .ai-progress.visible { display: block; }
    .ai-spinner {
      width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid #8B5CF6; border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 1rem;
    }
    .ai-spinner.paused { animation: none; border-color: rgba(255,100,100,0.5); border-top-color: #ff4444; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ai-progress-text { color: rgba(255,255,255,0.7); font-size: 0.9rem; }
    .progress-steps {
      display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;
    }
    .step-dot {
      width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.1);
      transition: all 0.3s;
    }
    .step-dot.active { background: #8B5CF6; box-shadow: 0 0 10px #8B5CF6; }
    .step-dot.done { background: #4ECDC4; }
    .step-dot.error { background: #ff4444; }

    /* Result */
    .ai-result { display: none; margin-bottom: 1.5rem; }
    .ai-result.visible { display: block; }
    .result-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 1rem;
    }
    .result-header h3 { font-size: 1.1rem; }
    .result-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .result-tab {
      padding: 0.5rem 1rem; background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 0.5rem;
      color: rgba(255,255,255,0.5); font-size: 0.8rem; font-weight: 600;
      font-family: 'Inter', sans-serif; cursor: pointer;
    }
    .result-tab:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .result-tab.active { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); color: #8B5CF6; }
    .result-content { display: none; }
    .result-content.active { display: block; }
    .result-content textarea {
      width: 100%; min-height: 400px; padding: 1rem;
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 0.5rem; color: #fff; font-size: 0.85rem;
      font-family: 'Consolas','Monaco',monospace; line-height: 1.6;
      resize: vertical; outline: none;
    }
    .result-content textarea:focus { border-color: #8B5CF6; }
    .result-char { text-align: right; font-size: 0.7rem; color: rgba(255,255,255,0.3); margin-top: 0.3rem; }

    /* Thumbnail Preview */
    .thumbnail-preview {
      margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 0.5rem;
      display: flex; align-items: center; gap: 1rem;
    }
    .thumbnail-img { width: 120px; height: 80px; object-fit: cover; border-radius: 0.25rem; background: #333; }
    .thumbnail-url { flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.6); font-family: monospace; font-size: 0.8rem; }

    .publish-all-section {
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(18,18,26,0.8); backdrop-filter: blur(15px);
      border: 1px solid rgba(139,92,246,0.15); border-radius: 1rem; padding: 1.5rem;
    }
    .publish-all-btn {
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, #00D4FF, #0066FF);
      border: none; border-radius: 0.75rem; color: #fff;
      font-size: 0.95rem; font-weight: 600; font-family: 'Inter', sans-serif;
      cursor: pointer; transition: all 0.3s;
    }
    .publish-all-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,255,0.35); }
    .publish-all-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .ai-tip {
      margin-top: 0.75rem; padding: 0.75rem 1rem;
      background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.15);
      border-radius: 0.5rem; font-size: 0.75rem; color: rgba(255,255,255,0.5);
    }
    .ai-tip strong { color: #8B5CF6; }

    /* Success Actions */
    .success-actions { margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; }
    .share-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: #000; padding: 0.75rem 1.5rem; border-radius: 2rem;
      color: #fff; text-decoration: none; font-weight: bold; font-size: 0.9rem;
      transition: transform 0.2s; border: 1px solid #333;
    }
    .share-btn:hover { transform: scale(1.05); }
    
    .keywords-box {
      margin-top: 1rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;
    }
    .keywords-title { font-size: 0.8rem; color: #8B5CF6; font-weight: bold; margin-bottom: 0.5rem; }
    .keyword-chip { 
      display: inline-block; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      padding: 0.3rem 0.6rem; border-radius: 0.25rem; font-size: 0.8rem; color: #ccc;
      margin-right: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;
    }
    .keyword-chip:hover { border-color: #8B5CF6; color: #fff; }

    /* Limit Warning */
    .limit-warning {
        background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3);
        color: #ff8888; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.8rem;
        margin-top: 1rem; display: none;
    }
    .limit-warning.visible { display: block; }
  </style>
</head>
<body>
  <div class="admin-bg"></div>
  <div class="admin-wrapper">
    <header class="admin-header">
      <div class="admin-logo">BLITZ<span class="dot">.</span><span class="badge">Admin</span></div>
      <a href="/admin/" class="back-btn">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
    </header>
    <h1 class="page-title">ğŸ¤– AIç”Ÿæˆãƒ¢ãƒ¼ãƒ‰</h1>
    <p class="page-desc">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› â†’ ç«¶åˆåˆ†æ â†’ 3ãƒµå›½è¨˜äº‹ä½œæˆï¼ˆç”»åƒä»˜ãï¼‰</p>

    <!-- Quota Info -->
    <div style="text-align:right; font-size:0.75rem; color:rgba(255,255,255,0.4); margin-bottom:0.5rem;">
        ä»Šæ—¥ã®æ®‹ã‚Šç”Ÿæˆå›æ•°: <span id="quotaCount">-</span> / 5å› (RPD: 20 reqs)
    </div>

    <!-- Input -->
    <div class="ai-input-section">
      <div class="keyword-row">
        <div class="keyword-field" style="flex:2;">
          <label>ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" id="keyword" placeholder="ä¾‹: Xiaomi 17 Ultra price in Japan 2026" />
        </div>
        <div class="keyword-field" style="flex:0.5;">
          <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
          <select id="genre">
            <option value="tech">Tech</option>
            <option value="lifestyle">Lifestyle</option>
            <option value="review">Review</option>
            <option value="news">News</option>
            <option value="economics">Economics</option>
          </select>
        </div>
        <button class="generate-btn" id="generateBtn" onclick="generateArticles()">ğŸ¤– AIç”Ÿæˆ</button>
      </div>
      <div class="ai-tip">
        <strong>ğŸ’¡ Enhanced:</strong> å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ãŸç”»åƒã‚’è‡ªå‹•æŒ¿å…¥ã—ã¾ã™ã€‚ç”Ÿæˆã«ã¯1ã€œ2åˆ†ã‹ã‹ã‚Šã¾ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿ã®ãŸã‚é †æ¬¡å®Ÿè¡Œã—ã¾ã™ï¼‰ã€‚
      </div>
      <div class="limit-warning" id="limitWarning">
          âš ï¸ æœ¬æ—¥ã®ç”Ÿæˆä¸Šé™ï¼ˆRPD 20ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥ã¾ãŸã”åˆ©ç”¨ãã ã•ã„ã€‚
      </div>
    </div>

    <!-- Progress -->
    <div class="ai-progress" id="aiProgress">
      <div class="ai-spinner" id="spinner"></div>
      <div class="ai-progress-text" id="aiProgressText">ğŸš€ æº–å‚™ä¸­...</div>
      <div class="progress-steps">
        <div class="step-dot" id="step1"></div>
        <div class="step-dot" id="step2"></div>
        <div class="step-dot" id="step3"></div>
        <div class="step-dot" id="step4"></div>
        <div class="step-dot" id="step5"></div>
      </div>
    </div>

    <!-- Result -->
    <div class="ai-result" id="aiResult">
      <div class="result-header">
        <h3>âœ¨ ç”Ÿæˆçµæœï¼ˆç·¨é›†å¯èƒ½ï¼‰</h3>
      </div>
      <div class="thumbnail-preview">
        <img id="thumbPreview" class="thumbnail-img" src="" alt="Thumbnail" />
        <input type="text" id="thumbUrl" class="thumbnail-url" placeholder="Thumbnail URL" readonly />
      </div>

      <div class="result-tabs" style="margin-top:1rem;">
        <button class="result-tab active" onclick="switchResultTab('jp', this)">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
        <button class="result-tab" onclick="switchResultTab('us', this)">ğŸ‡ºğŸ‡¸ US English</button>
        <button class="result-tab" onclick="switchResultTab('in', this)">ğŸ‡®ğŸ‡³ India</button>
      </div>
      <div class="result-content active" id="result-jp">
        <textarea id="result-jp-text"></textarea>
        <div class="result-char" id="result-jp-count">0 æ–‡å­—</div>
      </div>
      <div class="result-content" id="result-us">
        <textarea id="result-us-text"></textarea>
        <div class="result-char" id="result-us-count">0 chars</div>
      </div>
      <div class="result-content" id="result-in">
        <textarea id="result-in-text"></textarea>
        <div class="result-char" id="result-in-count">0 chars</div>
      </div>

      <div class="publish-all-section" style="margin-top:1rem;">
        <div class="publish-info">
          <strong>ğŸ“¤ 3ãƒµå›½åˆ†ã‚’ä¸€æ‹¬å…¬é–‹</strong><br>
          <span style="font-size:0.8rem;color:rgba(255,255,255,0.4)">GitHubã«ã‚³ãƒŸãƒƒãƒˆ â†’ Vercelã§è‡ªå‹•ãƒ“ãƒ«ãƒ‰</span>
        </div>
        <button class="publish-all-btn" id="publishAllBtn" onclick="publishAll()">ğŸš€ ä¸€æ‹¬å…¬é–‹</button>
      </div>
    </div>
  </div>

  <!-- Progress Overlay for publishing -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-card">
      <h3 id="progressTitle">ğŸ“¤ å…¬é–‹ä¸­...</h3>
      <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
      <p class="progress-status" id="progressStatus">æº–å‚™ä¸­...</p>
      <div class="progress-result" id="progressResult"></div>
      <button class="progress-close" id="progressClose">âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</button>
    </div>
  </div>

  <script is:inline>
    if (sessionStorage.getItem('blitz_admin_auth') !== 'true') window.location.href = '/admin/login';

    let generatedSlug = '';
    let suggestedKeywords = [];
    
    // RPD Logic
    const MAX_RPD = 20;
    const REQUESTS_PER_RUN = 4; // Analysis + JP + US + IN
    const MAX_RUNS_PER_DAY = Math.floor(MAX_RPD / REQUESTS_PER_RUN); // 5

    function getQuota() {
        const today = new Date().toLocaleDateString('ja-JP');
        const key = `blitz_ai_usage_${today}`;
        const count = parseInt(localStorage.getItem(key) || '0', 10);
        return { key, count };
    }

    function checkQuota() {
        const { count } = getQuota();
        const remaining = Math.max(0, MAX_RUNS_PER_DAY - count);
        document.getElementById('quotaCount').textContent = remaining;
        
        const btn = document.getElementById('generateBtn');
        const warn = document.getElementById('limitWarning');
        
        if (remaining <= 0) {
            btn.disabled = true;
            btn.innerText = 'ğŸš« æœ¬æ—¥ã®ä¸Šé™åˆ°é”';
            warn.classList.add('visible');
            return false;
        } else {
            warn.classList.remove('visible');
            return true;
        }
    }
    
    function incrementQuota() {
        const { key, count } = getQuota();
        localStorage.setItem(key, (count + 1).toString());
        checkQuota();
    }

    // Init check
    checkQuota();

    // Char count listeners
    ['jp','us','in'].forEach(lang => {
      const el = document.getElementById(`result-${lang}-text`);
      const ct = document.getElementById(`result-${lang}-count`);
      if (el && ct) el.addEventListener('input', () => { ct.textContent = `${el.value.length} æ–‡å­—`; });
    });

    window.switchResultTab = function(lang, btn) {
      document.querySelectorAll('.result-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.result-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`result-${lang}`).classList.add('active');
    };

    function updateStep(stepIndex, status) {
      const dots = document.querySelectorAll('.step-dot');
      if (status === 'active') { dots[stepIndex].classList.add('active'); dots[stepIndex].classList.remove('error'); }
      if (status === 'done') {
        dots[stepIndex].classList.remove('active');
        dots[stepIndex].classList.add('done');
      }
      if (status === 'error') {
          dots[stepIndex].classList.add('error');
      }
    }
    
    async function fetchWithRetry(url, options, retryCount = 0) {
        try {
            const res = await fetch(url, options);
            if (res.status === 429) {
                // Rate Limit Hit
                // If user RPD is not reached, this is short-term RPM limit. Wait 60s.
                throw new Error('RATE_LIMIT');
            }
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            if (e.message === 'RATE_LIMIT' || e.message.includes('429')) {
                if (retryCount < 3) {
                    // Update UI to show waiting
                    const msg = document.getElementById('aiProgressText');
                    const spinner = document.getElementById('spinner');
                    spinner.classList.add('paused');
                    
                    let timeLeft = 60;
                    const interval = setInterval(() => {
                        msg.textContent = `â³ APIåˆ¶é™ä¸­... ã‚ã¨${timeLeft}ç§’ã§å†é–‹`;
                        timeLeft--;
                        if (timeLeft <= 0) clearInterval(interval);
                    }, 1000);
                    
                    await new Promise(r => setTimeout(r, 60000)); // Wait 60s
                    
                    spinner.classList.remove('paused');
                    return fetchWithRetry(url, options, retryCount + 1);
                } else {
                    throw new Error('APIåˆ¶é™ãŒè§£é™¤ã•ã‚Œã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                }
            }
            throw e;
        }
    }

    // === Sequential AI Generation ===
    window.generateArticles = async function() {
      if (!checkQuota()) return;

      const keyword = document.getElementById('keyword').value.trim();
      const genre = document.getElementById('genre').value;
      if (!keyword) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const btn = document.getElementById('generateBtn');
      const progress = document.getElementById('aiProgress');
      const progressText = document.getElementById('aiProgressText');
      const result = document.getElementById('aiResult');
      
      // Reset UI
      btn.disabled = true; 
      progress.classList.add('visible'); 
      result.classList.remove('visible');
      document.querySelectorAll('.step-dot').forEach(d => { d.className = 'step-dot'; });
      
      generatedSlug = keyword.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').substring(0, 60);

      try {
        // Step 1: Analysis
        updateStep(0, 'active');
        progressText.textContent = 'ğŸ” ç«¶åˆãƒ»æ§‹æˆåˆ†æä¸­...';
        const context = await fetchWithRetry('/api/generate', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ mode: 'analysis', keyword, genre })
        });
        suggestedKeywords = context.suggested_keywords || [];
        updateStep(0, 'done');

        // Step 2: JP Article
        updateStep(1, 'active');
        progressText.textContent = 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªè¨˜äº‹ã‚’åŸ·ç­†ä¸­...';
        const jpData = await fetchWithRetry('/api/generate', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ mode: 'article', lang: 'jp', keyword, genre, context })
        });
        document.getElementById('result-jp-text').value = jpData.content;
        updateStep(1, 'done');

        // Step 3: US Article
        updateStep(2, 'active');
        progressText.textContent = 'ğŸ‡ºğŸ‡¸ USè¨˜äº‹ã‚’åŸ·ç­†ä¸­...';
        const usData = await fetchWithRetry('/api/generate', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ mode: 'article', lang: 'us', keyword, genre, context })
        });
        document.getElementById('result-us-text').value = usData.content;
        updateStep(2, 'done');

        // Step 4: IN Article
        updateStep(3, 'active');
        progressText.textContent = 'ğŸ‡®ğŸ‡³ ã‚¤ãƒ³ãƒ‰è¨˜äº‹ã‚’åŸ·ç­†ä¸­...';
        const inData = await fetchWithRetry('/api/generate', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ mode: 'article', lang: 'in', keyword, genre, context })
        });
        document.getElementById('result-in-text').value = inData.content;
        updateStep(3, 'done');

        // Step 5: Thumbnail (Pexels - less strict limit, but wrap anyway)
        updateStep(4, 'active');
        progressText.textContent = 'ğŸ–¼ï¸ ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’æ¤œç´¢ä¸­...';
        try {
            const thumbData = await fetchWithRetry('/api/generate', {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ mode: 'thumbnail', query: keyword })
            });
            document.getElementById('thumbUrl').value = thumbData.url;
            document.getElementById('thumbPreview').src = thumbData.url || '';
        } catch(e) {} // Ignore thumb error
        updateStep(4, 'done');

        // Increment Quota ONLY after success
        incrementQuota();

        // Finish
        progress.classList.remove('visible');
        result.classList.add('visible');
        ['jp','us','in'].forEach(lang => {
          const el = document.getElementById(`result-${lang}-text`);
          el.dispatchEvent(new Event('input'));
        });

      } catch (e) {
        progress.classList.remove('visible');
        alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
        btn.disabled = false;
        // Mark error step?
        // simple reset
      }
      
      checkQuota(); // Re-enable btn if quota left
    };

    // === Publish All ===
    window.publishAll = async function() {
      const token = localStorage.getItem('blitz_gh_token');
      if (!token) { alert('è¨­å®šã‹ã‚‰Github Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const jp = document.getElementById('result-jp-text').value;
      const us = document.getElementById('result-us-text').value;
      const ind = document.getElementById('result-in-text').value;
      const thumb = document.getElementById('thumbUrl').value;
      const injectThumb = (content, url) => content.replace('image: ""', `image: "${url}"`);

      if (!jp) return;
      const files = [];
      if (jp) files.push({ path: `src/content/articles/${generatedSlug}.md`, content: injectThumb(jp, thumb) });
      if (us) files.push({ path: `src/content/articles/en-us/${generatedSlug}.md`, content: injectThumb(us, thumb) });
      if (ind) files.push({ path: `src/content/articles/hi-in/${generatedSlug}.md`, content: injectThumb(ind, thumb) });

      const overlay = document.getElementById('progressOverlay');
      const bar = document.getElementById('progressBar');
      const resultEl = document.getElementById('progressResult');
      const closeBtn = document.getElementById('progressClose');
      
      overlay.classList.add('visible');
      bar.style.width = '10%';
      resultEl.innerHTML = '';
      closeBtn.classList.remove('visible');
      
      try {
         const res = await fetch('/api/commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files, token, message: `Add ${generatedSlug}` })
         });
         const data = await res.json();
         if (data.success) {
            bar.style.width = '100%';
            document.getElementById('progressTitle').textContent = 'ğŸ‰ å…¬é–‹å®Œäº†ï¼';
            
            const kwHtml = suggestedKeywords.map(k => 
              `<span class="keyword-chip" onclick="navigator.clipboard.writeText('${k}');alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')">${k}</span>`
            ).join('');
            
            const shareText = encodeURIComponent('æ–°ã—ã„è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼ #ProjectBlitz #AIWriter');
            const shareUrl = encodeURIComponent(`https://project-blitz.vercel.app/articles/${generatedSlug}`);
            const twitterLink = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;

            resultEl.innerHTML = `
              <div class="result-item success">âœ… å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒŸãƒƒãƒˆå®Œäº†</div>
              <div class="success-actions">
                <a href="${twitterLink}" target="_blank" class="share-btn">
                  <span style="font-size:1.2rem">ğ•</span> Xã§ã‚·ã‚§ã‚¢
                </a>
                <div class="keywords-box">
                  <div class="keywords-title">ğŸ’¡ æ¬¡ã®è¨˜äº‹ã®ãƒ’ãƒ³ãƒˆ (ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼)</div>
                  ${kwHtml || '<span style="color:#666;font-size:0.8rem">ææ¡ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã—</span>'}
                </div>
              </div>
            `;
         } else {
            throw new Error('Some files failed');
         }
      } catch(e) {
         document.getElementById('progressTitle').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
         resultEl.innerHTML = `<div class="result-item fail">${e.message}</div>`;
      }
      
      closeBtn.classList.add('visible');
      resultEl.classList.add('visible');
    };
    
    document.getElementById('progressClose').addEventListener('click', () => { window.location.href = '/admin/'; });
  </script>
</body>
</html>
